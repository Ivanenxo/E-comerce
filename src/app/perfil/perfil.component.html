<!-- Barra de usuario -->
<div *ngIf="user" class="bg-gray-100 p-4 shadow-md flex flex-wrap items-center gap-3 md:flex-nowrap md:gap-4">

  <!-- Información del usuario -->
  <div class="flex flex-col w-full md:w-auto">
    <h3 class="text-base md:text-lg font-bold truncate">👋 Bienvenido: {{ user.username }}</h3>
    <h3 class="text-sm md:text-lg font-bold text-gray-600">Rol: {{ user.rol }}</h3>
    <div *ngIf="cliente && user.rol === 'VENDEDOR'" class="mt-2 bg-blue-50 border border-blue-200 rounded-md p-2">
      <p class="text-xs text-gray-600">Cliente seleccionado:</p>
      <h3 class="text-sm font-medium text-blue-700 truncate">{{ cliente.NombreComercial }}</h3>
    </div>
  </div>

  <!-- Botones principales -->
  <div class="flex flex-wrap justify-start md:justify-center w-full md:w-auto gap-2">
    <button class="text-blue-500 text-sm font-medium hover:underline" (click)="goToTienda()">🏪 Tienda</button>
    <button class="text-blue-500 text-sm font-medium hover:underline" (click)="goToOrdenes()">🗒️ Mis órdenes</button>
    <button
      *ngIf="user.rol === 'VENDEDOR'"
      class="text-blue-500 text-sm font-medium hover:underline"
      (click)="goToClientes()"
    >
      💼 Mis Clientes
    </button>

    <button class="text-blue-500 text-sm font-medium relative hover:underline" (click)="toggleCart()">
      🛒 Carrito
      <span
        *ngIf="cartItems.length > 0"
        class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
      >
        {{ cartItemCount }}
      </span>
    </button>
  </div>

  <!-- Selección de cliente (solo vendedores) -->
  <div *ngIf="user.rol === 'VENDEDOR'" class="w-full md:w-72 mt-2 md:mt-0 md:ml-auto">
    <h3 class="text-sm font-semibold mb-1 text-gray-800">Seleccionar Cliente</h3>

    <input
      type="text"
      [(ngModel)]="filtroCliente"
      placeholder="Buscar cliente..."
      class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm mb-2 focus:ring-1 focus:ring-blue-400 focus:outline-none"
      (focus)="onFocusInput()"
      (blur)="onBlurInput()"
    />

    <div
      class="max-h-24 overflow-y-auto border border-gray-300 rounded-md bg-white shadow-sm"
      *ngIf="clientesFiltrados.length > 0 && mostrarLista"
    >
      <ul class="divide-y divide-gray-100">
        <li
          *ngFor="let c of clientesFiltrados"
          (click)="seleccionarCliente(c)"
          class="px-2 py-1 hover:bg-blue-100 cursor-pointer text-sm"
        >
          {{ c.NombreComercial }}
          <span class="text-gray-500 text-xs">({{ c.Ciudad }})</span>
        </li>
      </ul>
    </div>

    <div *ngIf="clientesFiltrados.length === 0" class="text-gray-500 text-xs mt-1">
      No se encontraron clientes.
    </div>


  </div>

  <!-- Botón cerrar sesión -->
  <button class="w-full md:w-auto text-red-500 font-medium hover:underline md:ml-auto" (click)="logout()">
    🚪 Cerrar sesión
  </button>
</div>

<!-- Carrito -->
<div *ngIf="cartVisible" class="bg-white p-4 shadow-md mt-4 rounded-md">
  <h3 class="text-lg font-bold mb-4 text-center md:text-left">Carrito</h3>

  <div *ngIf="cartItems.length > 0; else emptyCart">
    <ul class="divide-y divide-gray-200">
      <li
        *ngFor="let item of cartItems"
        class="flex flex-col md:flex-row md:items-center justify-between py-3 gap-3"
      >
        <!-- Checkbox -->
        <div class="flex items-center">
          <input
            type="checkbox"
            [value]="true"
            [(ngModel)]="selectedItems[item.Codigo]"
            (change)="onItemSelected(item)"
            class="w-4 h-4"
          />
        </div>

        <!-- Imagen + info -->
        <div class="flex items-center space-x-3 flex-1">
          <img
            [src]="apiUrl + 'api/Productos/foto/' + item.Codigo + '-1.jpg'"
            alt="{{ item.Nombre }}"
            class="w-14 h-14 rounded object-cover"
            (error)="onImageError($event)"
          />
          <div>
            <strong
              class="block text-sm truncate max-w-[160px]"
              title="{{item.NombreFull}}"
              (click)="selectItem(item)"
            >
              {{ item.NombreFull }}
            </strong>
            <p class="text-xs text-gray-500">{{item.Referencia}}</p>
            <p
              [ngClass]="{
                'text-green-500': item.Disponibilidad === 'DISPONIBLE',
                'text-orange-500': item.Disponibilidad === 'SOBRE_PEDIDO',
                'text-yellow-500': item.Disponibilidad === 'CONSULTAR_ASESOR'
              }"
              class="text-xs"
            >
              {{ item.Disponibilidad }}
            </p>
          </div>
        </div>

        <!-- Controles -->
        <div class="flex items-center gap-2">
          <button class="px-2 py-1 bg-red-500 text-white rounded" (click)="decreaseQuantity(item)">-</button>
          <input
            type="number"
            [(ngModel)]="item.Cantidad"
            class="w-14 text-center border rounded"
            (ngModelChange)="updateQuantity(item)"
            (blur)="updateQuantity(item)"
          />
          <button class="px-2 py-1 bg-green-500 text-white rounded" (click)="increaseQuantity(item)">+</button>
          <button class="px-2 py-1 bg-orange-600 text-white rounded" (click)="deleteQuantity(item)">🗑️</button>
        </div>

        <!-- Precio total -->
        <div class="text-sm font-semibold text-gray-700 text-right w-full md:w-auto">
          {{ calculateTotalPrice(item) | currency:'USD' }}
        </div>
      </li>
    </ul>

    <div class="flex flex-col md:flex-row justify-between items-center mt-4">
      <div class="text-lg font-bold">Total: {{ calculateCartTotal() | currency:'USD' }}</div>
      <button
        *ngIf="cartItems.length > 0"
        class="mt-2 md:mt-0 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600"
        (click)="cerrarcotizacion()"
      >
        ✅ Cerrar cotización
      </button>
    </div>
  </div>

  <ng-template #emptyCart>
    <p class="text-center text-gray-500">Aún no hay productos en el carrito.</p>
  </ng-template>
</div>
